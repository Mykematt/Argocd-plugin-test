steps:
  # Fetch secrets once for entire pipeline
  - label: "ğŸ” Fetch ArgoCD Secrets"
    key: "fetch-argocd-secrets"
    command: "echo 'âœ… ArgoCD secrets fetched for pipeline'"
    agents:
      queue: mac
    plugins:
      - secrets#v1.0.0:
          variables:
            ARGOCD_PASSWORD: argocd_password

  - label: "ğŸš€ Step 1: Deploy Baseline (Working Version)"
    key: "deploy-baseline"
    depends_on: "fetch-argocd-secrets"
    agents:
      queue: kubernetes
    plugins:
      - github.com/Mykematt/argocd-deployment-buildkite-plugin#main:
          app: "test-nginx-app"
          argocd_server: "https://localhost:8080"
          argocd_username: "admin"
          mode: "deploy"
          timeout: 120
          health_check: true
          health_check_interval: 15
          health_check_timeout: 120
          notifications:
            slack_channel: "buildkite#ola-testing"

  - label: "ğŸ’¥ Step 2: Deploy Broken Version (Auto-Rollback Test)"
    key: "deploy-broken-auto-rollback"
    depends_on: "deploy-baseline"
    agents:
      queue: kubernetes
    plugins:
      - github.com/Mykematt/argocd-deployment-buildkite-plugin#main:
          app: "test-nginx-app-broken"
          argocd_server: "https://localhost:8080"
          argocd_username: "admin"
          mode: "deploy"
          timeout: 120
          health_check: true
          health_check_interval: 15
          health_check_timeout: 60
          notifications:
            email: "michael.omoge@buildkite.com"

  - label: "ğŸš« Step 3: Deploy Broken Version (No Auto-Rollback)"
    key: "deploy-broken-no-rollback"
    depends_on: "deploy-broken-auto-rollback"
    agents:
      queue: kubernetes
    plugins:
      - github.com/Mykematt/argocd-deployment-buildkite-plugin#main:
          app: "test-nginx-app-broken"
          argocd_server: "https://localhost:8080"
          argocd_username: "admin"
          mode: "deploy"
          timeout: 60
          health_check: false  # Disabled - no auto-rollback
          notifications:
            webhook_url: "https://webhook.site/#!/view/c494b825-a554-4a11-87fe-7f596f06e1c7"

  - label: "ğŸ”„ Step 4: Manual Rollback"
    key: "manual-rollback"
    depends_on: "deploy-broken-no-rollback"
    agents:
      queue: kubernetes
    plugins:
      - github.com/Mykematt/argocd-deployment-buildkite-plugin#main:
          app: "test-nginx-app-broken"
          argocd_server: "https://localhost:8080"
          argocd_username: "admin"
          mode: "rollback"
          rollback_mode: "manual"
          timeout: 120
          collect_logs: true
          log_lines: 1000
          upload_artifacts: true
          notifications:
            pagerduty_integration_key: "3d9447131fa34d03d0816fc7ed069157"
